name: Release Desktop + Mobile App

on:
  push:
    tags:
      - 'v*' # Trigger on tags like v1.0.0

permissions:
  contents: write # Needed to create GitHub Releases

jobs:
  release:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Tests (Sanity Check)
        run: npm run test

      - name: Build Web App
        run: npm run build

      # electron-builder only builds; upload is handled separately below
      # to avoid the known concurrent-blockmap-upload bug with --publish always
      - name: Build Electron App (no publish)
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
        run: npx electron-builder --publish never

      - name: Collect release artifacts
        shell: bash
        run: |
          mkdir -p dist-artifacts
          find release -maxdepth 2 \( \
            -name "*.dmg" -o -name "*.zip" -o -name "*.exe" \
            -o -name "*.msi" -o -name "*.AppImage" \
            -o -name "*.deb" -o -name "*.rpm" \
          \) -exec cp {} dist-artifacts/ \; || true

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist-artifacts/*
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  android_release:
    needs: release
    if: needs.release.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Install dependencies
        run: npm ci

      - name: Build Web App
        run: npm run build

      - name: Sync Android platform
        run: |
          if [ ! -d android ]; then
            npx cap add android
          fi
          npx cap sync android
          chmod +x android/gradlew

      - name: Build Android Debug APK
        run: |
          cd android
          ./gradlew assembleDebug

      - name: Collect Android artifact
        run: |
          mkdir -p artifacts/android
          cp android/app/build/outputs/apk/debug/app-debug.apk "artifacts/android/card-duel-${GITHUB_REF_NAME}-android-debug.apk"

      - name: Upload Android asset to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: artifacts/android/*.apk
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ios_release:
    needs: release
    if: needs.release.result == 'success'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build Web App
        run: npm run build

      - name: Sync iOS platform
        run: |
          if [ ! -d ios ]; then
            npx cap add ios
          fi
          npx cap sync ios

      - name: Build iOS simulator app (no signing)
        run: |
          set -euo pipefail
          DERIVED_DATA="$RUNNER_TEMP/derived-data"
          LOG_PATH="$RUNNER_TEMP/ios-build.log"

          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath "$DERIVED_DATA" \
            CODE_SIGNING_ALLOWED=NO | tee "$LOG_PATH"

          APP_PATH="$(find "$DERIVED_DATA/Build/Products" -type d -name '*.app' | head -n 1)"
          if [ -z "$APP_PATH" ]; then
            echo "No simulator .app output found."
            exit 1
          fi

          mkdir -p artifacts/ios
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "artifacts/ios/card-duel-${GITHUB_REF_NAME}-ios-simulator-app.zip"
          cp "$LOG_PATH" "artifacts/ios/card-duel-${GITHUB_REF_NAME}-ios-build.log"

      - name: Upload iOS assets to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            artifacts/ios/*.zip
            artifacts/ios/*.log
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
